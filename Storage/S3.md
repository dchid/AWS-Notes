# S3

---

- AWS S3 is an object storage service spread across a uniform address space

## Use Cases

- Uses for S3 include:
  - Backup and Storage
  - Disaster Recovery
  - Archive
  - Hybrid Cloud storage
  - Application hosting
  - Data lakes and big data analytics
  - Static websites

## Features

- Files in s3 have a max size of 5 TB
- Supports checksums using common hashing algorithms like md5, sha1, and sha256
- S3 event notifications can be used to notify of creation, removal, restoration, or replication of objects
- Offers 99.999999999% (11 9s) of durability
- *S3 Select* allows the filtering of data using SQL
- Batch Operations can be used to perform bulk operations on existing objects in S3 with a single request
- *S3 Inventory* operations can list objects in a bucket without calling the S3 List API
- S3 Access logs can be stored in buckets within the same region
- **Never** set a logging bucket to be the same as the monitored bucket as it will create an infinite logging loop

## Buckets

- Files in S3 are stored in *Buckets*
- Buckets are created in a specific region
- S3 buckets do **not** have file trees, but object keys give the appearance of a hierarchy
- There are restrictions on bucket names
  - Must be globally unique
  - follow regex `(?!(^xn--|.+-s3alias$))^[a-z0-9][a-z0-9-]{1,61}[a-z0-9]$`):
  - No uppercase of underscore
  - 3-63 characters in length
  - must start with lowercase letter or number
  - must **not** start with prefix `xn--`
  - must **not** end with suffix `-s3alias`

## Requests

- S3 offers several http request methods
  - `PUT`
  - `COPY`
  - `POST`
  - `DELETE`
  - `GET`
  - `HEAD`
- http GET requests can be run in parallel by requesting specific byte ranges using a *Byte-Range Fetch*
- S3 offers 3500 http requests per second per prefix
- Transfer Speed can be increased using *S3 Transfer Acceleration* which utilizes edge locations

## Replication

- Can be replicated across different regions or even different accounts
- Versioning must be enabled on both source and destination bucket
- Supports both cross-region replication (CRR) and same-region replication (SRR)
    - CRR is useful for compliance, lower latency access, cross account replication
    - SRR useful for log aggregation, live replication between prod and test accounts
- Copying is asynchronous
- Requires IAM permissions
- Only new objects are replicated
- Use S3 batch Replication to replicate existing objects
- There is an optional setting to replicate delete markers
- Replication can not be chained

## Versioning

- Objects can have versions
- Versioning is enabled at the bucket level
- Any object uploaded prior to enabling versioning will not have a version
- Versions are assigned a version ID
- For a bucket to be deleted, all versions of all objects must be deleted first
- If an object is deleted with bucket versioning enabled, a _delete marker_ will be placed on older versions

## Security

- Bucket access, authorization, and security is managed by bucket policies
- Bucket policies are JSON based and have several components:
  - Resources: buckets and objects
  - Effect: Allow | Deny
  - Actions: Set of APIs to allow or deny
  - Principle: The entity being granted access
- Bucket Policies can restrict access by IP address
- Object permissions can be managed by an ACL
- Buckets have four block public access options which override bucket policies
  - Block public access to buckets and objects granted through _new_ access control lists (ACLs)
  - Block public access to buckets and objects granted through _any_ access control lists (ACLs)
  - Block public access to buckets and objects granted through _new_ public bucket or access point policies
  - Block public and cross-account access to buckets and objects through _any_ public bucket or access point policies
- Supports SSL for encryption in transit
- There are four encryption options for S3:
  - SSE-S3: Server-Side Encryption with AWS managed key
  - SSE-KMS: Server-Side Encryption with KMS key
  - SSE-C: Server-Side Encryption with customer provided keys
  - CSE: Client-Side Encryption
- Double encryption using KMS (DSSE-KMS) is supported as well
- Server-Side Encryption with S3 managed key (SSE-S3) is enabled by default for new buckets and objects
- S3 Supports TLS for in transit encryption
- Bucket policies can be used to enforce encryption
- Multi Factor Authentication is required to permanently delete an object version or suspend versioning on a bucket
- Only the root account can enable or disable MDA Delete
- *S3 Object Locks* allow the blocking of deletion of a specific object version for a specific amount of time
- Object Locks support three modes:
  - Retention Mode - Compliance: Objects can't be overwritten or deleted until retention period expires
  - Retention Mode - Governance: Some users can delete the object or change retention period settings
  - Legal Hold: Protects an object indefinitely until an authorized user deletes it

## Networking

- An origin is a protocol, domain, and port combined
- *Cross Origin Resource Sharing (CORS)* is a browser based mechanism to allow requests to other origins while visiting the main origin
- The correct CORS headers must be enabled for CORS to work
- *Pre-Signed URLs* inherit the permissions of the user which generated the URL for GET or PUT
  - Can be created using CLI or Console
  - URLs expire after set amount of time
- *S3 Access Points* allow for the restriction of access to objects with certain prefixes to certain IAM users and groups
  - Access points have their own DNS name and an access point policy
  - VPC endpoints can be created to restrict access to access points within a VPC
  - *Multi Region Access Points* provide a global endpoint for buckets
- Private connections from private subnets to S3 buckets can be established using VPC Endpoint Endpoint Gateway

## Storage Classes

| Tier | Availability | Qualities | Use case | Retrieval | Min Storage Duration |
| --- | --- | --- | --- | --- | --- |
| **Standard** | 99.99% | Standard frequent access | Data lake, content distribution | Milliseconds | None |
| **Standard Infrequent Access** | 99.9% | Less frequent but rapid access | Disaster recovery | Milliseconds | 30 Days |
| **One Zone Infrequent Access** | 99.5% | Less frequent but rapid access | Secondary Backups | Milliseconds | 30 Days |
| **Glacier Instant Retrieval** | 99.9 | Infrequent, but rapid access | Archives and backups | Milliseconds | 90 Days |
| **Glacier Flexible Retrieval** | 99.99% | Infrequent, but slow access | Archives and backups | Minutes or Hours | 90 Days |
| **Glacier Deep Archive** | 99.99% | Infrequent, very slow access | Archives and backups | Hours | 90 Days |
| **Intelligent Tiering** | 99.9% | Access patterns unknown | Various | Milliseconds | None |

- A *Lifecycle Configuration* is an XML file containing rules used to manage objects
- There are two categories of rules
    - *Transaction Rules* are used move objects between tiers
    - *Expiration Rules* are used to delete objects
- Rules can be applied by to a key prefix or a tag

## Glacier

- Each item in Glacier is referred to as an *Archive*, and they are stored in *Vaults*
- Data in Glacier is automatically encrypted with AES-256 keys managed by AWS
- Vaults can only be deleted when it's empty
- Metadata and inventory lists can be retrieved from vaults
- Every vault has two json based policies:
  - Access policies act like bucket policies
  - Lock policies are immutable policies to restrict certain actions
- Glacier Vault Locks support *Write Once Read Many (WORM)* model
- Vaults can be configured to send messages to SNS when restoration is complete
- Restore Links have expiration dates
- S3 event notifications can also alert users to restoration options:
  - `S3:ObjectRestorePost` Notifies when object restoration is initiated
  - `S3:ObjectRestoreCompleted` Notifies when object restoration is Completed

## Event Notifications

- S3 Event notifications are alerts to certain actions taken on buckets and objects
- Some S3 Events calls include:
    - S3:ObjectCreated
    - S3:ObjectRemoved
    - S3:ObjectRestore
    - S3:Replication
- Event notifications require proper IAM permissions using *Resource Access Policies*
- Event notifications can be sent to SQS, SNS, and Lambda
- Event notifications integrate with EventBridge

## Multi Part Upload

- Need to use multi-part upload when uploading files larger than 5GB
- Can help Parallelize uploads
- Supports a max of 10,000 parts
- Parts of an object can be uploaded in any order
- Lifecyle Policies can automatically delete failed upload parts
- Works through CLI or SDK
