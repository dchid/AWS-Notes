# Elastic Load Balancer
 
 ---

- Elastic Load Balancer is a service to optimize distributed routing of network traffic

## Features

- High availability means to replicate data across more that 1 availability zone
- Vertical Scaling means to provision larger instances
- Horizontal Scaling means to provision more instances
- Load Balancers route traffic to multiple downstream instances
- Elastic Load Balancers can:
  - Expose a single DNS endpoint for multiple servers
  - Perform health checks
  - Provide HTTPS and SSL/TLS
  - Enforce stickiness with cookies
  - Spread traffic across multiple Availability Zones
  - Separate public and private traffic
- ELB is an AWS managed service

## Health Checks

- Health Checks require several things
  - port number
  - network protocol
  - endpoint (path)
  - timeout
  - Interval (frequency for sending health checks)
  - Healthy Threshold (number of health checks need to consider target healthy)
  - Unhealthy Threshold (number of health checks need to consider target unhealthy)

## Load Balancer Types

- AWS has four types of load balancers:

| - | Application Load Balancer | Network Load Balancer | Gateway Load Balancer | Classic Load Balancer|
| --- | --- | --- | --- | --- |
| **Network Layer** | 7 Application Layer | 4 Transport Layer | 3 Network Layer | 4 Transport Layer |
| **Routs Traffic to** | EC2, ECS, Lambda, IP address | TCP and UDP traffic | Private IP addresses | EC2 |
| **Ideal for** | micro-services and containerization | Health Checks over TCP, HTTP, HTTPS | Firewalls and Payload Manipulation | For Classic EC2 instances |
| **Cross Zone Load Balancing** | Enabled by Default | Disabled by Default | N/A | Enabled by Default |
| **Dual Stack Networking** | Yes | Yes | No | No|
| **Notes** | Supports stickiness using cookies | 1 static IP per AZ | Uses GENEVE protocol on port 6081 | Support for TCP and SSL listeners, and sticky sessions |

## Stickiness

- _Stickiness_ (AKA session affinity) is when an LB maps traffic from one client to one specific instance using cookies.
- Application based cookies:
  - Custom cookies:
    - Are generated by the target
    - Can include custom attributes as required by application
    - Cookie name must be specific for each target group
    - Can't use names [`AWSALB`, `AWSALBAPP`, `AWSALBTG`]
  - Application cookies:
    - automatically generated by LB
    - Name is AWSALBAPP
- Duration based cookies
  - Generated by LB
  - Name is AWSALB
  - Expired based on a duration specified by LB

## Cross Zone Load Balancing

- Cross Zone Load Balancing distributes traffic evenly across all AZs
- If Cross Zone Load Balancing isn't used, the traffic is divided evenly among instances in AZ
- LBs come with a TLS cert, but users can upload their own certs
- Clients can us Server Name Indication (SNI) to specify the host name they reach
    - SNI a protocol which is used to load multiple certs onto one server so that the server can host multiple websites
    - SNI will require the client to indicate hostname of target server during TLS handshake
    - SNI will only work on ALB, NLB and CloudFront
- A Deregristration Delay will allow unhealthy instances to complete requests while it is being marked unhealthy without allowing new connections
- Targets can contain several health statuses
    - Initial (registered)
    - Healthy
    - Unhealthy
    - Unused (not registered)
    - Draining
    - Unavailable (health checks disabled)
- If an target group contains only unhealthy targets, it will distribute traffic across all targets
- LBs push metrics directly to CloudWatch

## Target Groups

- Target Groups are groups of resources to send ELB traffic to
- Target Groups have several settings:
    - Deregistration delay
    - Load Balancing (scheduling) algorithm:
        - Least outstanding requests
        - Round Robin
        - Flow Hash (based on hash of IP, protocol, port, TCP sequence number)
    - Slow start (send traffic gradually to EC2 instance to give time to start)
    - Stickiness (enabled or disabled)
    - Stickiness cookie name
    - Stickiness cookie duration
    - Listener Rules
- ALB Listeners have sequential rules with actions for a specific targets
- rule conditions include:
    - `host-header`
    - `http-request-method` (get, post)
    - `path-pattern`
    - `source-ip`
    - `http-header`
    - `query-string`
- Target groups can be weighted in a rule
    - This enables a blue/green deployment

## Dual Stack Networking

- *Dual Stack Networking* allows use of both IPv4 and IPv6 protocols
- Dual Stack Networking is useful when it's unknown which protocol a client will use
- An ELB using DSN has 3 URLs, one for IPv4, one for IPv6, and a dual-stack name to route to one or the other
- Target groups can support both IPv4 and IPv6 targets, but they need to be segregated in separate target groups
- DSN can automatically convert IPv6 requests to IPv4
